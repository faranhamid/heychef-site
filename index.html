<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HeyChef!">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#4f46e5" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#1d4ed8">
    <meta name="description" content="HeyChef! - AI-powered personalized recipes for culinary innovation. Discover custom meals tailored to your cravings and dietary needs.">
    <meta property="og:title" content="HeyChef! - Culinary Innovation with AI">
    <meta property="og:description" content="Experience personalized, AI-generated recipes that fit your lifestyle. Subscribe today and elevate your cooking game.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1555939594-58d7cb2e254f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80">
    <meta property="og:url" content="https://yourdomain.com">
    <title>HeyChef! - AI-Powered Culinary Innovation</title>
    <link rel="icon" href="https://via.placeholder.com/32?text=HC" type="image/png">
    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>
<body>
    <header class="navbar">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="logo">
            <nav class="nav-links desktop-nav">
                <a href="#home" onclick="handleNavClick(event, 'home')">Home</a>
                <a href="#features" onclick="handleNavClick(event, 'features')">Features</a>
                <a href="#how-it-works" onclick="handleNavClick(event, 'how-it-works')">How It Works</a>
                <a href="#subscriptions" onclick="handleNavClick(event, 'subscriptions')">Subscriptions</a>
                <a href="#testimonials" onclick="handleNavClick(event, 'testimonials')">Testimonials</a>
                <a href="#faq" onclick="handleNavClick(event, 'faq')">FAQ</a>
                <a href="https://docs.google.com/forms/d/e/1FAIpQLScVcxfhDDyvJRZISvcA7xZj1tDJxzvcEA2hZ7_6G7SoJ939OQ/viewform?usp=header" target="_blank">Affiliate</a>
            </nav>
            <div class="auth-controls" id="auth-controls">
                <button class="cta-button login-btn" onclick="signInWithGoogle()">Sign In with Google</button>
            </div>
            <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="mobile-nav" id="mobile-nav">
            <a href="#home" onclick="handleNavClick(event, 'home')">Home</a>
            <a href="#features" onclick="handleNavClick(event, 'features')">Features</a>
            <a href="#how-it-works" onclick="handleNavClick(event, 'how-it-works')">How It Works</a>
            <a href="#subscriptions" onclick="handleNavClick(event, 'subscriptions')">Subscriptions</a>
            <a href="#testimonials" onclick="handleNavClick(event, 'testimonials')">Testimonials</a>
            <a href="#faq" onclick="handleNavClick(event, 'faq')">FAQ</a>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScVcxfhDDyvJRZISvcA7xZj1tDJxzvcEA2hZ7_6G7SoJ939OQ/viewform?usp=header" target="_blank">Affiliate</a>
        </nav>
    </header>

    <section id="home" class="hero-section">
        <div class="hero-background">
            <img src="https://images.unsplash.com/photo-1555939594-58d7cb2e254f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="Delicious AI-generated meal" loading="lazy">
            <div class="hero-overlay"></div>
        </div>
        
        <!-- Floating decorative elements -->
        <div class="floating-elements">
            <div class="floating-icon" style="top: 15%; left: 10%; animation-delay: 0s;">
                <i class="fas fa-utensils"></i>
            </div>
            <div class="floating-icon" style="top: 25%; right: 15%; animation-delay: 1s;">
                <i class="fas fa-leaf"></i>
            </div>
            <div class="floating-icon" style="top: 60%; left: 5%; animation-delay: 2s;">
                <i class="fas fa-fire"></i>
            </div>
            <div class="floating-icon" style="top: 70%; right: 10%; animation-delay: 3s;">
                <i class="fas fa-heart"></i>
            </div>
            <div class="floating-icon" style="top: 85%; left: 20%; animation-delay: 4s;">
                <i class="fas fa-star"></i>
            </div>
        </div>
        
        <div class="container">
            <div class="hero-content animate__animated animate__fadeIn">
                <h1>Revolutionize Your Kitchen with AI-Powered Recipes</h1>
                <div class="hero-cta-container">
                    <a href="#subscriptions" class="cta-button hero-cta">
                        <span>Start Your Culinary Journey</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section id="features" class="features-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">Why Choose HeyChef!?</h2>
            <p class="section-intro">Discover the features that make HeyChef! the ultimate tool for modern cooking. Our AI-driven platform combines technology with culinary expertise to bring you endless inspiration.</p>
            <div class="features-grid">
                <div class="feature-card">
                    <img src="https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Couple cooking together" loading="lazy">
                    <h3>Personalized Recipes</h3>
                    <p>Tailor-made meals based on your max calories, protein preferences, and more. Say goodbye to generic cookbooks and hello to recipes that suit you perfectly.</p>
                </div>
                <div class="feature-card">
                    <img src="https://images.unsplash.com/photo-1490645935967-10de6ba17061?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Nutritional insights" loading="lazy">
                    <h3>Detailed Nutrition</h3>
                    <p>Get comprehensive breakdowns of calories, proteins, fats, carbs, and more. Make informed choices for a healthier you.</p>
                </div>
                <div class="feature-card">
                    <img src="https://images.unsplash.com/photo-1543353071-873f17a7a088?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Easy instructions" loading="lazy">
                    <h3>Step-by-Step Instructions</h3>
                    <p>Clear, easy-to-follow guides with ingredients lists and preparation steps. Perfect for beginners and pros alike.</p>
                </div>
                <div class="feature-card">
                    <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Community and affiliates" loading="lazy">
                    <h3>Affiliate Program</h3>
                    <p>Join our community and earn 20% commissions by sharing HeyChef! with your network.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="how-it-works" class="how-it-works-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">How HeyChef! Works</h2>
            <p class="section-intro">Getting started is simple. Follow these steps to unlock a world of personalized culinary delights.</p>
            <div class="steps-grid">
                <div class="step">
                    <img src="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Sign up" loading="lazy">
                    <h3>1. Sign Up & Subscribe</h3>
                    <p>Create an account and choose a plan to access our premium features.</p>
                </div>
                <div class="step">
                    <img src="https://images.unsplash.com/photo-1497032628192-86f99bcd76bc?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Input preferences" loading="lazy">
                    <h3>2. Input Your Preferences</h3>
                    <p>Enter max calories and what you're craving – our AI does the rest.</p>
                </div>
                <div class="step">
                    <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Generate recipes" loading="lazy">
                    <h3>3. Generate & Enjoy</h3>
                    <p>Browse AI-generated recipes, complete with images, nutrition, and instructions.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="subscriptions" class="subscription-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">Choose Your Subscription Plan</h2>
            <p class="section-intro">Unlock unlimited access to personalized recipes with our flexible plans. Save more with annual billing.</p>
            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>Monthly Plan</h3>
                    <p class="price">$9.99 <span>/month</span></p>
                    <ul class="features">
                        <li>Unlimited recipe generations</li>
                        <li>Personalized AI recommendations</li>
                        <li>Detailed nutritional analysis</li>
                        <li>Access to community forums</li>
                        <li>Priority customer support</li>
                    </ul>
                    <button id="monthly-subscribe" class="cta-button">Subscribe Now</button>
                </div>
                <div class="pricing-card featured">
                    <span class="featured-badge">Best Value</span>
                    <h3>Annual Plan</h3>
                    <p class="price">$99.99 <span>/year</span> <span class="save">(Save 16%)</span></p>
                    <ul class="features">
                        <li>Unlimited recipe generations</li>
                        <li>Personalized AI recommendations</li>
                        <li>Detailed nutritional analysis</li>
                        <li>Access to community forums</li>
                        <li>Priority customer support</li>
                        <li>Exclusive recipe collections</li>
                        <li>Early access to new features</li>
                    </ul>
                    <button id="annual-subscribe" class="cta-button">Subscribe Now</button>
                </div>
            </div>
        </div>
    </section>

    <section id="testimonials" class="testimonials-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">What Our Users Say</h2>
            <p class="section-intro">Hear from real people who have transformed their cooking with HeyChef!.</p>
            <div class="testimonials-grid">
                <div class="testimonial-card">
                    <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User avatar" loading="lazy">
                    <p>"HeyChef! has revolutionized my meal planning. The AI suggestions are spot on!"</p>
                    <h4>- Sarah J., Fitness Enthusiast</h4>
                </div>
                <div class="testimonial-card">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User avatar" loading="lazy">
                    <p>"Incredible value! The recipes are delicious and easy to follow."</p>
                    <h4>- Mike T., Busy Professional</h4>
                </div>
                <div class="testimonial-card">
                    <img src="https://randomuser.me/api/portraits/women/65.jpg" alt="User avatar" loading="lazy">
                    <p>"As a vegetarian, finding varied recipes was hard – until HeyChef!"</p>
                    <h4>- Emily R., Home Chef</h4>
                </div>
            </div>
        </div>
    </section>

    <section id="affiliate" class="affiliate-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">Become an Affiliate Partner</h2>
            <p class="section-description">Earn a generous 20% recurring commission for every referral that subscribes. Join a community of influencers and food lovers promoting innovative culinary tech. With easy tracking and marketing tools, maximize your earnings while sharing the joy of AI-powered cooking.</p>
            <button class="cta-button" onclick="window.location.href='https://docs.google.com/forms/d/e/1FAIpQLScVcxfhDDyvJRZISvcA7xZj1tDJxzvcEA2hZ7_6G7SoJ939OQ/viewform?usp=header';">Apply Today</button>
        </div>
    </section>

    <section id="faq" class="faq-section">
        <div class="container">
            <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-intro">Got questions? We've got answers. Explore common queries about HeyChef!.</p>
            <div class="faq-accordion">
                <div class="faq-item">
                    <button class="faq-question">What makes HeyChef! different from other recipe apps?</button>
                    <div class="faq-answer">
                        <p>HeyChef! uses advanced AI to generate truly personalized recipes based on your specific inputs, unlike static databases in other apps.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">Can I cancel my subscription anytime?</button>
                    <div class="faq-answer">
                        <p>Yes, subscriptions can be canceled at any time through your account settings.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">Is HeyChef! suitable for dietary restrictions?</button>
                    <div class="faq-answer">
                        <p>Absolutely! Input your preferences, and our AI will tailor recipes accordingly, including vegan, gluten-free, and more.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-question">How secure is my data?</button>
                    <div class="faq-answer">
                        <p>We prioritize privacy with encrypted data and compliance with industry standards. See our Privacy Policy for details.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main id="recipe-section" class="recipe-section" style="display: none;">
        <div class="generator-hero">
            <img src="https://images.unsplash.com/photo-1495195134817-aeb325a55b65?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="AI Recipe Generator Background" loading="lazy">
            <div class="generator-overlay"></div>
            <div class="generator-content">
                <h1>Unlock Endless Culinary Possibilities with AI</h1>
                <p>Our advanced AI generator creates custom recipes tailored to your tastes. Input your preferences below and watch the magic happen. From quick snacks to gourmet dinners, HeyChef! has you covered with innovative, healthy, and delicious ideas.</p>
            </div>
        </div>
        <div class="container">
            <section id="recipe-form-section" class="recipe-form-section">
                <img src="images/logo.png" alt="HeyChef! Logo" class="section-logo">
                <h2 class="section-title">Create Your Personalized Recipe</h2>
                <p class="section-intro">Enter your details below, and let our AI craft the perfect meal for you. Experiment with different cravings and calorie limits to discover new favorites.</p>
                <div class="form-container">
                    <label for="calories">Maximum Calories</label>
                    <input type="number" id="calories" placeholder="e.g., 500" required>
                    <label for="protein">What Are You Craving?</label>
                    <input type="text" id="protein" placeholder="e.g., chicken, tofu, pasta" required>
                    <button type="button" class="cta-button" onclick="generateRecipes()">Generate Recipes</button>
                </div>
                <div class="generator-tips">
                    <h3>Pro Tips for Best Results</h3>
                    <ul>
                        <li>Be specific with your cravings for more accurate suggestions.</li>
                        <li>Try combining ingredients like "vegan pasta" or "low-carb chicken."</li>
                        <li>Adjust calorie limits to match your dietary goals.</li>
                        <li>Browse multiple recipes using the navigation buttons.</li>
                    </ul>
                </div>
            </section>
            <section id="results" class="results-section">
                <div class="results-intro">
                    <h3>Your Generated Recipes</h3>
                    <p>Explore the AI-curated recipes below. Each one includes detailed nutrition, ingredients, and step-by-step instructions. Navigate through options to find your perfect match.</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-logo">
                    <img src="images/logo.png" alt="HeyChef! Logo" class="footer-logo-img">
                    <p>AI-Powered Culinary Innovation</p>
                </div>
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#features">Features</a></li>
                        <li><a href="#subscriptions">Subscriptions</a></li>
                        <li><a href="#affiliate">Affiliate</a></li>
                    </ul>
                </div>
                <div class="footer-social">
                    <h4>Follow Us</h4>
                    <a href="https://x.com/Heychefmenu" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.instagram.com/heychefmenu/?hl=en" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
                </div>
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <p>Email: support@heychef.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2025 HeyChef! All Rights Reserved. <a href="#privacy" onclick="showPrivacyPolicy(event)">Privacy Policy</a> | <a href="#terms" onclick="showTermsOfService(event)">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">×</span>
            <div id="modal-text"></div>
        </div>
    </div>

    <script type="module">
        // Firebase and Auth logic remains similar, with adjustments for new elements
        const firebaseConfig = {
            apiKey: "AIzaSyC1jGVeSifZHrfkLSNeiM7E27u5zBta8LA",
            authDomain: "heychef-20b0b.firebaseapp.com",
            projectId: "heychef-20b0b",
            storageBucket: "heychef-20b0b.firebasestorage.app",
            messagingSenderId: "807625257042",
            appId: "1:807625257042:web:9cee7a67d15c940239af8b",
            measurementId: "G-JN8NT9C3M7"
        };
        
        // Debug: Log current domain for Firebase troubleshooting
        console.log('Current domain:', window.location.hostname);
        console.log('Current URL:', window.location.href);

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signInWithPopup, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Debug: Check if Firebase is initialized
        console.log('Firebase initialized:', !!app);
        console.log('Auth initialized:', !!auth);
        console.log('Firestore initialized:', !!db);
        
        // Test Firebase connection on load
        window.addEventListener('load', () => {
            console.log('🚀 BULLETPROOF PAYMENT DETECTION SYSTEM INITIALIZED');
            
            // Test Firebase connection
            const testDoc = doc(db, 'test', 'connection');
            getDoc(testDoc).then(() => {
                console.log('✅ Firebase connection successful');
            }).catch((error) => {
                console.log('❌ Firebase connection failed:', error.message);
            });
            
            // MULTIPLE PAYMENT SUCCESS INDICATORS
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const sessionId = urlParams.get('session_id');
            const paymentIntent = urlParams.get('payment_intent');
            const customerId = urlParams.get('customer_id');
            
            console.log('🔍 PAYMENT DETECTION:', {
                search: window.location.search,
                paymentStatus: paymentStatus,
                sessionId: sessionId,
                paymentIntent: paymentIntent,
                customerId: customerId,
                fullUrl: window.location.href,
                referrer: document.referrer
            });
            
            // BULLETPROOF PAYMENT SUCCESS DETECTION
            const isPaymentSuccess = paymentStatus === 'success' || 
                                   sessionId || 
                                   paymentIntent || 
                                   customerId ||
                                   document.referrer.includes('stripe.com') ||
                                   document.referrer.includes('checkout.stripe.com') ||
                                   window.location.href.includes('stripe.com') ||
                                   window.location.href.includes('checkout.stripe.com') ||
                                   sessionStorage.getItem('paymentSuccess') === 'true';
            
            if (isPaymentSuccess) {
                console.log('🎉 PAYMENT SUCCESS DETECTED! GRANTING IMMEDIATE PREMIUM ACCESS');
                
                // Clear URL parameters immediately
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Store payment success indicators
                sessionStorage.setItem('paymentSuccess', 'true');
                sessionStorage.setItem('paymentTimestamp', Date.now().toString());
                sessionStorage.setItem('paymentSessionId', sessionId || '');
                sessionStorage.setItem('paymentIntent', paymentIntent || '');
                
                // Show success message
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: var(--accent); margin-bottom: 1rem;">🎉 Payment Successful!</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Thank you for subscribing to HeyChef!</p>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">Your subscription is now active. You have unlimited access to our AI-powered recipe generator!</p>
                        <button class="cta-button" onclick="closeModal()" style="margin: 0 auto;">Start Cooking!</button>
                    </div>
                `;
                document.getElementById('modal').style.display = 'flex';
                
                // IMMEDIATE PREMIUM ACCESS GRANTING
                if (auth.currentUser) {
                    console.log('✅ User logged in - granting immediate premium access');
                    grantPremiumAccess(auth.currentUser);
                } else {
                    console.log('⏳ User not logged in - will grant access when they sign in');
                }
                
            } else if (paymentStatus === 'cancelled') {
                console.log('❌ Payment cancelled');
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: #6b7280; margin-bottom: 1rem;">Payment Cancelled</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">No worries! You can subscribe anytime to unlock our premium features.</p>
                        <button class="cta-button" onclick="closeModal()" style="margin: 0 auto;">Continue Browsing</button>
                    </div>
                `;
                document.getElementById('modal').style.display = 'flex';
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // BULLETPROOF PREMIUM ACCESS GRANTING FUNCTION
        async function grantPremiumAccess(user) {
            try {
                console.log('🚀 GRANTING PREMIUM ACCESS TO:', user.email);
                
                // Update Firestore with premium status (with error handling)
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    await setDoc(userDocRef, {
                        subscribed: true,
                        paymentConfirmed: true,
                        lastChecked: new Date(),
                        paymentSuccessDate: new Date(),
                        stripeStatus: 'active',
                        cancelAtPeriodEnd: false,
                        email: user.email,
                        uid: user.uid
                    }, { merge: true });
                    
                    console.log('✅ Firestore updated with premium status');
                } catch (firestoreError) {
                    console.warn('⚠️ Firestore update failed, but continuing:', firestoreError);
                    // Continue even if Firestore fails
                }
                
                // Update UI immediately
                updateAccountStatusDisplay(user, true);
                showRecipeGenerator();
                showWelcomeMessage(user.email);
                
                // Clear payment flags
                sessionStorage.removeItem('paymentSuccess');
                sessionStorage.removeItem('paymentTimestamp');
                sessionStorage.removeItem('paymentSessionId');
                sessionStorage.removeItem('paymentIntent');
                
                console.log('✅ Premium access granted successfully');
                
            } catch (error) {
                console.error('❌ Error granting premium access:', error);
                // Even if Firestore fails, grant access
                updateAccountStatusDisplay(user, true);
                showRecipeGenerator();
                showWelcomeMessage(user.email);
            }
        }

        // Helper Functions
        function showWelcomeMessage(email) {
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">🎉 Welcome to HeyChef!</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Hi ${email.split('@')[0]}! You're all set to start creating amazing recipes.</p>
                    <p style="color: var(--text-light);">Your subscription is active and you now have unlimited access to our AI-powered recipe generator!</p>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                document.getElementById('modal').style.display = 'none';
            }, 3000);
        }

        // Function to update account status display
        function updateAccountStatusDisplay(user, subscribed) {
            const authControls = document.getElementById('auth-controls');
            const accountStatus = subscribed ? 'Premium' : 'Free';
            authControls.innerHTML = `
                <div class="user-dropdown">
                    <span class="user-email" onclick="toggleUserDropdown()">${user.email} <span class="account-status ${subscribed ? 'premium' : 'free'} animate__animated animate__pulse">${accountStatus}</span> <i class="fas fa-chevron-down"></i></span>
                    <div class="dropdown-menu" id="user-dropdown-menu">
                        <div class="dropdown-item" onclick="showAccountInfo()">
                            <i class="fas fa-user"></i>
                            <span>Account Info</span>
                        </div>
                        <div class="dropdown-item" onclick="showSubscriptionDetails()">
                            <i class="fas fa-credit-card"></i>
                            <span>Subscription</span>
                        </div>
                                                        ${subscribed ? `<div class="dropdown-item" onclick="showUnsubscribeModal()"><i class="fas fa-times-circle"></i><span>Unsubscribe</span></div>` : `<div class="dropdown-item" onclick="showUpgradePrompt()"><i class="fas fa-crown"></i><span>Upgrade to Premium</span></div>`}
                                <div class="dropdown-item" onclick="refreshSubscriptionStatus()"><i class="fas fa-sync-alt"></i><span>Refresh Status</span></div>
                                <div class="dropdown-item" onclick="debugPaymentState()"><i class="fas fa-bug"></i><span>Debug Payment</span></div>
                                <div class="dropdown-item" onclick="forcePremiumAccess()"><i class="fas fa-crown"></i><span>Force Premium Access</span></div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="signOutUser()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Add a brief flash effect to indicate status change
            const statusElement = authControls.querySelector('.account-status');
            if (statusElement) {
                statusElement.style.animation = 'none';
                setTimeout(() => {
                    statusElement.style.animation = 'pulse 0.6s ease-in-out';
                }, 10);
            }
        }

        function showSubscriptionRequired() {
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">🔒 Subscription Required</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">To access our AI-powered recipe generator, you need an active subscription.</p>
                    <p style="color: var(--text-light); margin-bottom: 2rem;">Choose a plan below to unlock unlimited recipe generation!</p>
                    <button class="cta-button" onclick="closeModal()" style="margin: 0 auto;">Get Started</button>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        // Modal Functions (unchanged)
        window.showPrivacyPolicy = function(event) {
            event.preventDefault();
            document.getElementById('modal-text').innerHTML = `
                <h2>Privacy Policy</h2>
                <p>At HeyChef!, we prioritize your privacy, collecting data only to enhance your experience. Your information is encrypted and used solely for service improvement, never shared without consent unless legally required. Contact support@heychef.com for data inquiries.</p>
            `;
            document.getElementById('modal').style.display = 'flex';
        };

        window.showTermsOfService = function(event) {
            event.preventDefault();
            document.getElementById('modal-text').innerHTML = `
                <h2>Terms of Service</h2>
                <p>By using HeyChef!, you agree to these terms. Services are provided 'as is,' with no liability for indirect damages. Users must be 13+; subscriptions follow our pricing policy. We may update terms with notice.</p>
            `;
            document.getElementById('modal').style.display = 'flex';
        };

        window.closeModal = function() {
            document.getElementById('modal').style.display = 'none';
        };

        // User Dropdown Functions
        window.toggleUserDropdown = function() {
            const dropdown = document.getElementById('user-dropdown-menu');
            dropdown.classList.toggle('active');
        };

        window.showAccountInfo = function() {
            const user = auth.currentUser;
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">👤 Account Information</h2>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto;">
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>User ID:</strong> ${user.uid}</p>
                        <p><strong>Account Created:</strong> ${user.metadata.creationTime ? new Date(user.metadata.creationTime).toLocaleDateString() : 'N/A'}</p>
                        <p><strong>Last Sign In:</strong> ${user.metadata.lastSignInTime ? new Date(user.metadata.lastSignInTime).toLocaleDateString() : 'N/A'}</p>
                    </div>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('user-dropdown-menu').classList.remove('active');
        };

        window.showSubscriptionDetails = function() {
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">💳 Subscription Details</h2>
                    <div style="text-align: left; max-width: 400px; margin: 0 auto;">
                        <p><strong>Status:</strong> <span style="color: var(--accent);">Active</span></p>
                        <p><strong>Plan:</strong> Premium Access</p>
                        <p><strong>Features:</strong></p>
                        <ul style="margin-left: 1rem;">
                            <li>Unlimited recipe generations</li>
                            <li>Personalized AI recommendations</li>
                            <li>Detailed nutritional analysis</li>
                            <li>Priority customer support</li>
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('user-dropdown-menu').classList.remove('active');
        };

        window.showUnsubscribeModal = function() {
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: #ef4444; margin-bottom: 1rem;">⚠️ Unsubscribe from HeyChef!</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Are you sure you want to cancel your subscription?</p>
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                        <p style="color: #dc2626; margin: 0;"><strong>What happens when you unsubscribe:</strong></p>
                        <ul style="text-align: left; margin: 1rem 0 0 0; padding-left: 1.5rem;">
                            <li>You'll lose access to the AI recipe generator</li>
                            <li>Your account will remain active but limited</li>
                            <li>You can resubscribe anytime</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="cta-button" onclick="closeModal()" style="background: #6b7280;">Cancel</button>
                        <button class="cta-button" onclick="confirmUnsubscribe()" style="background: #ef4444;">Yes, Unsubscribe</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('user-dropdown-menu').classList.remove('active');
        };

        window.localUnsubscribe = async function() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('No user logged in');
                    return;
                }

                // Update user subscription status in Firestore only
                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    subscribed: false,
                    unsubscribedDate: new Date(),
                    subscriptionType: 'cancelled',
                    localCancellation: true
                }, { merge: true });

                // Update account status display to show Free
                updateAccountStatusDisplay(user, false);

                // Show success message
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: var(--accent); margin-bottom: 1rem;">✅ Locally Unsubscribed</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Your local subscription has been cancelled.</p>
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                            <p style="color: #92400e; margin: 0;"><strong>Important:</strong></p>
                            <p style="color: #92400e; margin: 0.5rem 0 0 0;">Please email support@heychef.com to cancel your Stripe billing subscription.</p>
                        </div>
                        <button class="cta-button" onclick="closeModal()">Close</button>
                    </div>
                `;

                // Redirect to subscription page after a delay
                setTimeout(() => {
                    closeModal();
                    // Force page reload to update UI
                    window.location.reload();
                }, 3000);

            } catch (error) {
                console.error('Error with local unsubscribe:', error);
                alert('Error updating local subscription. Please try again.');
            }
        };

        window.confirmUnsubscribe = async function() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('No user logged in');
                    return;
                }

                // Show loading state
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <h3>Cancelling Subscription...</h3>
                        <p>Please wait while we process your request.</p>
                    </div>
                `;

                // Call backend API to cancel Stripe subscription
                try {
                    const response = await fetch('/api/unsubscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.uid,
                            email: user.email
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage;
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error || 'Failed to cancel subscription';
                        } catch (parseError) {
                            errorMessage = `Server error: ${response.status} ${response.statusText}`;
                        }
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                } catch (apiError) {
                    console.log('Backend API unavailable, using local cancellation:', apiError);
                    
                    // Fallback: Show manual cancellation instructions
                    modalText.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2 style="color: var(--primary); margin-bottom: 1rem;">📧 Manual Cancellation Required</h2>
                            <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Our automated system is temporarily unavailable.</p>
                            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                                <p style="color: #0369a1; margin: 0;"><strong>To cancel your subscription:</strong></p>
                                <ol style="text-align: left; margin: 1rem 0 0 0; padding-left: 1.5rem;">
                                    <li>Email us at <strong>support@heychef.com</strong></li>
                                    <li>We'll cancel your subscription within 24 hours</li>
                                </ol>
                            </div>
                            <p style="color: var(--text-light); margin-bottom: 2rem;">We apologize for the inconvenience.</p>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="cta-button" onclick="closeModal()" style="background: #6b7280;">Close</button>
                                <button class="cta-button" onclick="localUnsubscribe()" style="background: #ef4444;">Cancel Locally</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Update user subscription status in Firestore
                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    subscribed: false,
                    unsubscribedDate: new Date(),
                    subscriptionType: 'cancelled',
                    stripeCancelledAt: result.cancelledAt
                }, { merge: true });

                // Update account status display to show Free
                updateAccountStatusDisplay(user, false);

                // Show success message
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: var(--accent); margin-bottom: 1rem;">✅ Unsubscribed Successfully</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">Your subscription has been cancelled.</p>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">You can resubscribe anytime by visiting our subscription page.</p>
                        <button class="cta-button" onclick="closeModal()">Close</button>
                    </div>
                `;

                // Redirect to subscription page after a delay
                setTimeout(() => {
                    closeModal();
                    // Force page reload to update UI
                    window.location.reload();
                }, 3000);

            } catch (error) {
                console.error('Error unsubscribing:', error);
                
                // Show error message
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: #ef4444; margin-bottom: 1rem;">❌ Error Cancelling Subscription</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">${error.message}</p>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">Please try again or contact support if the problem persists.</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="cta-button" onclick="closeModal()" style="background: #6b7280;">Close</button>
                            <button class="cta-button" onclick="showUnsubscribeModal()" style="background: #ef4444;">Try Again</button>
                        </div>
                    </div>
                `;
            }
        };

        // Authentication Logic
        window.isSubscribed = async function(user) {
            if (!user) {
                console.log('❌ No user provided to isSubscribed');
                return false;
            }
            
            console.log('🔍 Checking subscription for user:', user.email);
            
            // First, check for payment success indicators
            const paymentSuccess = sessionStorage.getItem('paymentSuccess');
            const paymentTimestamp = sessionStorage.getItem('paymentTimestamp');
            const paymentSessionId = sessionStorage.getItem('paymentSessionId');
            const paymentIntent = sessionStorage.getItem('paymentIntent');
            
            console.log('🔍 Payment indicators:', {
                paymentSuccess,
                paymentTimestamp,
                paymentSessionId,
                paymentIntent
            });
            
            // If we have recent payment indicators, grant access
            if (paymentSuccess === 'true' && paymentTimestamp) {
                const timeDiff = Date.now() - parseInt(paymentTimestamp);
                if (timeDiff < (30 * 60 * 1000)) { // Within 30 minutes
                    console.log('✅ Recent payment detected - granting access');
                    return true;
                }
            }
            
            if (paymentSessionId || paymentIntent) {
                console.log('✅ Payment indicators found - granting access');
                return true;
            }
            
            // Check Firestore cache
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('📊 Firestore cache data:', userData);
                    
                    // If we have recent cache data (within last 5 minutes), use it
                    if (userData.lastChecked && userData.subscribed) {
                        const lastChecked = new Date(userData.lastChecked.toDate());
                        const now = new Date();
                        const diffMinutes = (now - lastChecked) / (1000 * 60);
                        
                        if (diffMinutes < 5) {
                            console.log('✅ Using cached subscription status:', userData.subscribed);
                            return userData.subscribed;
                        }
                    }
                }
            } catch (error) {
                console.log('⚠️ Error reading Firestore cache:', error);
            }
            
            // Try backend API
            try {
                console.log('📡 Making request to /api/subscription-status...');
                const response = await fetch('http://localhost:3001/api/subscription-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: user.email
                    })
                });
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('📡 Raw API response:', result);
                    
                    // STRICT CHECK: Only allow if Stripe confirms BOTH subscription AND payment
                    const hasSubscription = result.subscribed === true;
                    const hasPayment = result.paymentConfirmed === true;
                    const isActive = result.status === 'active';
                    
                    console.log('🔍 Subscription checks:', {
                        hasSubscription,
                        hasPayment,
                        isActive,
                        email: user.email
                    });
                    
                    if (hasSubscription && hasPayment && isActive) {
                        console.log('✅ User has paid subscription - granting access');
                                        // Update Firestore cache (with error handling)
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    await setDoc(userDocRef, {
                        subscribed: true,
                        paymentConfirmed: true,
                        lastChecked: new Date(),
                        stripeStatus: result.status,
                        cancelAtPeriodEnd: result.cancelAtPeriodEnd
                    }, { merge: true });
                    console.log('✅ Firestore cache updated successfully');
                } catch (firestoreError) {
                    console.warn('⚠️ Firestore update failed, but continuing:', firestoreError);
                    // Continue even if Firestore fails
                }
                        return true;
                    } else {
                        console.log('❌ User does not have paid subscription - denying access');
                        console.log('❌ Reason:', {
                            subscribed: result.subscribed,
                            paymentConfirmed: result.paymentConfirmed,
                            status: result.status
                        });
                        
                        // Update Firestore cache to false (with error handling)
                        try {
                            const userDocRef = doc(db, 'users', user.uid);
                            await setDoc(userDocRef, {
                                subscribed: false,
                                paymentConfirmed: false,
                                lastChecked: new Date(),
                                stripeStatus: result.status || 'none',
                                cancelAtPeriodEnd: result.cancelAtPeriodEnd || false
                            }, { merge: true });
                            console.log('✅ Firestore cache updated to false');
                        } catch (firestoreError) {
                            console.warn('⚠️ Firestore update failed, but continuing:', firestoreError);
                            // Continue even if Firestore fails
                        }
                        return false;
                    }
                } else {
                    console.log('❌ Backend API error:', response.status, response.statusText);
                    throw new Error(`Backend error: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Error checking subscription status:', error);
                
                // If backend is not accessible, check if user has payment success flag
                const paymentSuccess = sessionStorage.getItem('paymentSuccess');
                if (paymentSuccess === 'true') {
                    console.log('🔄 Backend unavailable but payment success detected - granting access');
                    return true;
                }
                
                // Check if user has any subscription data in Firestore
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscribed || userData.paymentConfirmed) {
                            console.log('✅ Found subscription data in Firestore');
                            return true;
                        }
                    }
                } catch (firestoreError) {
                    console.error('Error checking Firestore:', firestoreError);
                }
                
                // If no backend and no payment success, deny access
                console.log('❌ No backend access and no payment success - denying access');
                return false;
            }
        };

        // 1. Update the onAuthStateChanged logic to show locked state for non-subscribers
        onAuthStateChanged(auth, async (user) => {
            try {
                const authControls = document.getElementById('auth-controls');
                const recipeSection = document.getElementById('recipe-section');
                const homeSection = document.getElementById('home');
                const featuresSection = document.getElementById('features');
                const howItWorksSection = document.getElementById('how-it-works');
                const subscriptionSection = document.getElementById('subscriptions');
                const testimonialsSection = document.getElementById('testimonials');
                const affiliateSection = document.getElementById('affiliate');
                const faqSection = document.getElementById('faq');

                if (user) {
                    console.log('🔍 AUTH STATE CHANGE - User logged in:', user.email);
                    
                    // BULLETPROOF PAYMENT SUCCESS DETECTION
                    const paymentSuccess = sessionStorage.getItem('paymentSuccess');
                    const paymentTimestamp = sessionStorage.getItem('paymentTimestamp');
                    const paymentSessionId = sessionStorage.getItem('paymentSessionId');
                    const paymentIntent = sessionStorage.getItem('paymentIntent');
                    
                    console.log('🔍 PAYMENT STATE:', {
                        paymentSuccess,
                        paymentTimestamp,
                        paymentSessionId,
                        paymentIntent,
                        userEmail: user.email
                    });
                    
                    // Check for recent payment (within 30 minutes)
                    const hasRecentPayment = paymentSuccess === 'true' && 
                                           paymentTimestamp && 
                                           (Date.now() - parseInt(paymentTimestamp)) < (30 * 60 * 1000);
                    
                    if (hasRecentPayment) {
                        console.log('🚀 RECENT PAYMENT DETECTED - GRANTING IMMEDIATE PREMIUM ACCESS');
                        await grantPremiumAccess(user);
                        return;
                    }
                    
                    // Check if user has any payment indicators
                    const hasPaymentIndicators = paymentSessionId || paymentIntent;
                    if (hasPaymentIndicators) {
                        console.log('🚀 PAYMENT INDICATORS DETECTED - GRANTING PREMIUM ACCESS');
                        await grantPremiumAccess(user);
                        return;
                    }
                    
                    // Normal subscription check
                    console.log('🔍 Performing normal subscription check...');
                    const subscribed = await window.isSubscribed(user);
                    console.log('🔍 Subscription check result:', subscribed);
                    
                    updateAccountStatusDisplay(user, subscribed);
                    
                    if (subscribed) {
                        console.log('✅ User has active subscription - showing recipe generator');
                        showRecipeGenerator();
                        showWelcomeMessage(user.email);
                        // Clear any old payment flags
                        sessionStorage.removeItem('paymentSuccess');
                        sessionStorage.removeItem('paymentTimestamp');
                        sessionStorage.removeItem('paymentSessionId');
                        sessionStorage.removeItem('paymentIntent');
                    } else {
                        console.log('❌ User does not have subscription - showing locked state');
                        // Show locked state for non-subscribers
                        recipeSection.style.display = 'block';
                        homeSection.style.display = 'none';
                        featuresSection.style.display = 'none';
                        howItWorksSection.style.display = 'none';
                        subscriptionSection.style.display = 'none';
                        testimonialsSection.style.display = 'none';
                        affiliateSection.style.display = 'none';
                        faqSection.style.display = 'none';
                        showLockedGenerator();
                    }
                } else {
                    console.log('🔍 AUTH STATE CHANGE - No user logged in');
                    // No user logged in - show landing page
                    authControls.innerHTML = `<button class="cta-button login-btn" onclick="signInWithGoogle()">Sign In with Google</button>`;
                    recipeSection.style.display = 'none';
                    homeSection.style.display = 'block';
                    featuresSection.style.display = 'block';
                    howItWorksSection.style.display = 'block';
                    subscriptionSection.style.display = 'block';
                    testimonialsSection.style.display = 'block';
                    affiliateSection.style.display = 'block';
                    faqSection.style.display = 'block';
                }
            } catch (error) {
                console.error('❌ Error in auth state change:', error);
                if (navigator.onLine && !error.message.includes('offline')) {
                    alert('Authentication error: ' + error.message);
                }
            }
        });

        // AUTOMATIC PAYMENT DETECTION ON PAGE LOAD
        document.addEventListener('DOMContentLoaded', function() {
            // Check for payment success indicators in URL or session storage
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const sessionId = urlParams.get('session_id');
            const paymentIntent = urlParams.get('payment_intent');
            const customerId = urlParams.get('customer_id');
            
            console.log('🔍 PAGE LOAD PAYMENT DETECTION:', {
                paymentStatus,
                sessionId,
                paymentIntent,
                customerId,
                referrer: document.referrer,
                currentUrl: window.location.href
            });
            
            // If we detect payment success, store it for when user signs in
            if (paymentStatus === 'success' || 
                sessionId || 
                paymentIntent || 
                customerId ||
                document.referrer.includes('stripe.com') ||
                window.location.href.includes('stripe.com')) {
                
                console.log('🎉 PAYMENT SUCCESS DETECTED ON PAGE LOAD');
                sessionStorage.setItem('paymentSuccess', 'true');
                sessionStorage.setItem('paymentTimestamp', Date.now().toString());
                sessionStorage.setItem('paymentSessionId', sessionId || '');
                sessionStorage.setItem('paymentIntent', paymentIntent || '');
                
                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // 2. Show locked generator for non-subscribers
        window.showLockedGenerator = function() {
            // Hide the recipe form for unpaid users
            const recipeFormSection = document.getElementById('recipe-form-section');
            if (recipeFormSection) {
                recipeFormSection.style.display = 'none';
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="locked-generator" style="text-align:center; padding:3rem;">
                    <div style="font-size:3rem; color:var(--primary); margin-bottom:1rem;"><i class="fas fa-lock"></i></div>
                    <h2 style="margin-bottom:1rem;">Unlock the AI Recipe Generator</h2>
                    <p style="margin-bottom:2rem;">Sign up is free! Subscribe to get unlimited access to personalized, AI-powered recipes, nutrition info, and more.</p>
                    <button class="cta-button" onclick="showUpgradePrompt()" style="font-size:1.2rem; padding:1rem 2.5rem;">Unlock with Subscription</button>
                    <div style="margin-top:2rem; color:var(--text-light); font-size:0.95rem;">Already subscribed? Please sign out and sign in again to refresh your access.</div>
                </div>
            `;
        };

        // Navigation functions to show/hide landing page and recipe generator
        window.showLandingPage = function() {
            const recipeSection = document.getElementById('recipe-section');
            const homeSection = document.getElementById('home');
            const featuresSection = document.getElementById('features');
            const howItWorksSection = document.getElementById('how-it-works');
            const subscriptionSection = document.getElementById('subscriptions');
            const testimonialsSection = document.getElementById('testimonials');
            const affiliateSection = document.getElementById('affiliate');
            const faqSection = document.getElementById('faq');

            // Hide recipe generator
            recipeSection.style.display = 'none';
            // Show all landing page sections
            homeSection.style.display = 'block';
            featuresSection.style.display = 'block';
            howItWorksSection.style.display = 'block';
            subscriptionSection.style.display = 'block';
            testimonialsSection.style.display = 'block';
            affiliateSection.style.display = 'block';
            faqSection.style.display = 'block';
        };
        window.showRecipeGenerator = function() {
            const recipeSection = document.getElementById('recipe-section');
            const homeSection = document.getElementById('home');
            const featuresSection = document.getElementById('features');
            const howItWorksSection = document.getElementById('how-it-works');
            const subscriptionSection = document.getElementById('subscriptions');
            const testimonialsSection = document.getElementById('testimonials');
            const affiliateSection = document.getElementById('affiliate');
            const faqSection = document.getElementById('faq');
            const recipeFormSection = document.getElementById('recipe-form-section');

            // Show recipe generator
            recipeSection.style.display = 'block';
            // Show recipe form for paid users
            if (recipeFormSection) {
                recipeFormSection.style.display = 'block';
            }
            // Hide landing page sections
            homeSection.style.display = 'none';
            featuresSection.style.display = 'none';
            howItWorksSection.style.display = 'none';
            subscriptionSection.style.display = 'none';
            testimonialsSection.style.display = 'none';
            affiliateSection.style.display = 'none';
            faqSection.style.display = 'none';
        };

        // Handler for navigation clicks
        window.handleNavClick = function(event, sectionId) {
            event.preventDefault();
            // Always show landing page sections first
            showLandingPage();
            // Scroll to the section after a short delay to ensure it's visible
            setTimeout(function() {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
            // Optionally close mobile nav if open
            const menu = document.getElementById('mobile-nav');
            if (menu && menu.classList.contains('active')) {
                menu.classList.remove('active');
            }
        };

        // 3. Show upgrade prompt modal
        window.showUpgradePrompt = function() {
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align:center; padding:2rem;">
                    <h2 style="color:var(--primary); margin-bottom:1rem;">Upgrade to Premium</h2>
                    <p style="font-size:1.1rem; margin-bottom:1.5rem;">Unlock unlimited AI recipe generations, nutrition info, and more. Choose a plan to get started!</p>
                    <div style="display:flex; flex-direction:column; gap:1rem; align-items:center;">
                        <button class="cta-button" onclick="redirectToWhop('monthly')" style="width:220px;">Monthly - $9.99/mo</button>
                        <button class="cta-button" onclick="redirectToWhop('annual')" style="width:220px;">Annual - $99.99/yr <span style='color:var(--accent);'>(Save 16%)</span></button>
                    </div>
                                            <div style="margin-top:2rem; color:var(--text-light); font-size:0.95rem;">Cancel anytime. Secure payment via Whop.</div>
                    <div style="margin-top:1rem; padding:1rem; background:#f3f4f6; border-radius:8px;">
                        <p style="font-size:0.9rem; color:#6b7280; margin-bottom:0.5rem;">Already paid? Click below to refresh your status:</p>
                        <button class="cta-button" onclick="refreshSubscriptionStatus()" style="background:#6b7280; font-size:0.9rem; padding:0.5rem 1rem;">Refresh Subscription Status</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
        };

        // Debug function to check current state and force premium access
        window.debugPaymentState = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const paymentSuccess = sessionStorage.getItem('paymentSuccess');
            const user = auth.currentUser;
            
            console.log('🔍 DEBUG - Current state:', {
                url: window.location.href,
                search: window.location.search,
                paymentStatus: paymentStatus,
                sessionStorage: paymentSuccess,
                user: user ? user.email : 'No user',
                referrer: document.referrer
            });
            
            // FORCE PREMIUM ACCESS FOR PAID USERS
            if (user && (paymentSuccess === 'true' || 
                        document.referrer.includes('stripe.com') || 
                        window.location.href.includes('stripe.com') ||
                        paymentStatus === 'success')) {
                console.log('🚀 FORCING PREMIUM ACCESS FOR PAID USER');
                grantPremiumAccess(user);
                alert('Premium access granted! You should now have access to the recipe generator.');
            } else {
                alert(`Debug Info:\nURL: ${window.location.href}\nPayment Status: ${paymentStatus}\nSession Storage: ${paymentSuccess}\nUser: ${user ? user.email : 'No user'}\nReferrer: ${document.referrer}`);
            }
        };

        // Force premium access for paid users
        window.forcePremiumAccess = function() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in first');
                return;
            }
            
            console.log('🚀 FORCING PREMIUM ACCESS FOR:', user.email);
            
            // Grant immediate premium access
            grantPremiumAccess(user);
            
            // Show success message
            const modalText = document.getElementById('modal-text');
            modalText.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h2 style="color: var(--accent); margin-bottom: 1rem;">🎉 Premium Access Granted!</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">You now have unlimited access to our AI-powered recipe generator!</p>
                    <p style="color: var(--text-light); margin-bottom: 2rem;">Your account has been updated to Premium status.</p>
                    <button class="cta-button" onclick="closeModal()" style="margin: 0 auto;">Start Cooking!</button>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
        };

        // Manual subscription status refresh
        window.refreshSubscriptionStatus = async function() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in first.');
                return;
            }
            
            try {
                console.log('🔄 Manually refreshing subscription status...');
                
                // Show loading state
                const modalText = document.getElementById('modal-text');
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <h3>Checking Subscription Status...</h3>
                        <p>Please wait while we verify your payment.</p>
                    </div>
                `;
                
                // Check for payment indicators first
                const paymentSuccess = sessionStorage.getItem('paymentSuccess');
                const paymentSessionId = sessionStorage.getItem('paymentSessionId');
                const paymentIntent = sessionStorage.getItem('paymentIntent');
                
                if (paymentSuccess === 'true' || paymentSessionId || paymentIntent) {
                    console.log('✅ Payment indicators found - granting premium access');
                    await grantPremiumAccess(user);
                    closeModal();
                    return;
                }
                
                const subscribed = await window.isSubscribed(user);
                console.log('📊 Manual refresh result:', subscribed);
                
                if (subscribed) {
                    // Update account status display to show Premium
                    updateAccountStatusDisplay(user, true);
                    showRecipeGenerator();
                    showWelcomeMessage(user.email);
                    closeModal();
                    // Clear payment success flag
                    sessionStorage.removeItem('paymentSuccess');
                    sessionStorage.removeItem('paymentTimestamp');
                    sessionStorage.removeItem('paymentSessionId');
                    sessionStorage.removeItem('paymentIntent');
                    console.log('✅ Manual refresh successful - Premium access granted');
                } else {
                    // Update account status display to show Free
                    updateAccountStatusDisplay(user, false);
                    modalText.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2 style="color: #ef4444; margin-bottom: 1rem;">❌ No Active Subscription</h2>
                            <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">We couldn't find an active subscription for your account.</p>
                            <p style="color: var(--text-light); margin-bottom: 2rem;">If you just completed payment, please wait a few minutes and try again, or contact support if the issue persists.</p>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="cta-button" onclick="closeModal()" style="background: #6b7280;">Close</button>
                                <button class="cta-button" onclick="refreshSubscriptionStatus()" style="background: var(--accent);">Try Again</button>
                            </div>
                        </div>
                    `;
                    console.log('❌ Manual refresh failed - no subscription found');
                }
            } catch (error) {
                console.error('Error refreshing subscription:', error);
                modalText.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2 style="color: #ef4444; margin-bottom: 1rem;">❌ Error Checking Status</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">There was an error checking your subscription status.</p>
                        <p style="color: var(--text-light); margin-bottom: 2rem;">Please check your internet connection and try again.</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="cta-button" onclick="closeModal()" style="background: #6b7280;">Close</button>
                            <button class="cta-button" onclick="refreshSubscriptionStatus()" style="background: var(--accent);">Try Again</button>
                        </div>
                    `;
            }
        };

        // 4. Redirect to Whop checkout
        window.redirectToWhop = function(plan) {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in first.');
                return;
            }
            let whopUrl = '';
            if (plan === 'monthly') {
                whopUrl = 'https://whop.com/checkout/plan_QAyjF6Q2hnSOe?d2c=true&email=' + encodeURIComponent(user.email);
            } else {
                whopUrl = 'https://whop.com/checkout/plan_nbdGYrSmUo2GH?d2c=true&email=' + encodeURIComponent(user.email);
            }
            window.location.href = whopUrl;
        };

        // 5. If a non-subscribed user tries to generate recipes, show locked modal
        window.generateRecipes = async function() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in first.');
                return;
            }
            
            // Check subscription status first
            const subscribed = await window.isSubscribed(user);
            if (!subscribed) {
                showUpgradePrompt();
                return;
            }

            const calories = document.getElementById('calories').value;
            const protein = document.getElementById('protein').value.trim();

            if (!calories || !protein) {
                alert('Please fill in all fields!');
                return;
            }

            // Show loading state
            const generateBtn = document.querySelector('#recipe-form-section .cta-button');
            if (generateBtn) {
                generateBtn.textContent = 'Generating Recipes...';
                generateBtn.disabled = true;
            }

            // Show loading in results section
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem;"></div>
                    <h3>Generating Your Recipes...</h3>
                    <p>Our AI is crafting personalized recipes just for you!</p>
                </div>
            `;

            try {
                console.log('🚀 Starting recipe generation...');
                console.log('📊 Input:', { calories, protein });
                
                // Use a more reliable API key or fallback to demo data
                const apiKey = '0bf784244ef74e47bb54de046d7da861';
                
                // Improve search query to be more specific
                let searchQuery = protein.toLowerCase();
                
                // Add common pasta types if user mentions pasta
                if (searchQuery.includes('pasta') || searchQuery.includes('noodle')) {
                    // Add popular pasta sauce types to the search
                    const pastaSauces = ['pesto', 'vodka', 'alfredo', 'marinara', 'carbonara', 'bolognese', 'aglio e olio'];
                    const randomSauce = pastaSauces[Math.floor(Math.random() * pastaSauces.length)];
                    searchQuery = `${searchQuery} ${randomSauce} pasta`;
                }
                
                // Make the search more specific by adding cooking method
                const cookingMethods = ['grilled', 'baked', 'pan-fried', 'roasted'];
                const randomMethod = cookingMethods[Math.floor(Math.random() * cookingMethods.length)];
                
                // Build a more specific search query
                const specificQuery = `${randomMethod} ${searchQuery}`;
                
                const url = `https://api.spoonacular.com/recipes/complexSearch?apiKey=${apiKey}&maxCalories=${calories}&number=25&addRecipeInformation=true&addRecipeNutrition=true&instructionsRequired=true&fillIngredients=true&query=${encodeURIComponent(specificQuery)}&sort=relevance`;
                
                console.log('Fetching recipes from:', url);
                const response = await fetch(url);
                
                console.log('📡 API Response status:', response.status);
                
                if (!response.ok) {
                    console.error('❌ API Error:', response.status, response.statusText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📡 API Response data:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                recipes = data.results || [];
                currentIndex = 0;
                
                if (recipes.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <h3>No recipes found</h3>
                            <p>Try different ingredients or calorie limits!</p>
                            <p style="color: var(--text-light); font-size: 0.9rem;">API Response: ${JSON.stringify(data)}</p>
                        </div>
                    `;
                    return;
                }
                
                console.log(`Found ${recipes.length} recipes`);
                displayRecipe();
                
            } catch (error) {
                console.error('❌ Recipe generation error:', error);
                
                // Show error message to user
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h3 style="color: #ef4444;">Recipe Generation Failed</h3>
                        <p>Sorry, we couldn't generate recipes right now.</p>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 1rem;">Error: ${error.message}</p>
                        <button class="cta-button" onclick="generateRecipes()" style="margin-top: 1rem;">Try Again</button>
                    </div>
                `;
                
                // Reset button state
                if (generateBtn) {
                    generateBtn.textContent = 'Generate Recipes';
                    generateBtn.disabled = false;
                }
                
                // Fallback to demo recipes if API fails
                try {
                    recipes = generateDemoRecipes(calories, protein);
                    currentIndex = 0;
                    
                    if (recipes.length > 0) {
                        resultsDiv.innerHTML = `
                            <div style="text-align: center; padding: 2rem; background: #fef3c7; border-radius: 12px; margin-bottom: 2rem;">
                                <h3>Demo Mode</h3>
                                <p>API temporarily unavailable. Showing demo recipes for your search.</p>
                            </div>
                        `;
                        displayRecipe();
                    }
                } catch (demoError) {
                    console.error('❌ Demo recipe generation also failed:', demoError);
                }
            } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <h3>Error Generating Recipes</h3>
                            <p>Please try again in a moment.</p>
                            <p style="color: var(--text-light); font-size: 0.9rem;">Error: ${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                // Reset button state
                if (generateBtn) {
                    generateBtn.textContent = 'Generate Recipes';
                    generateBtn.disabled = false;
                }
            }
        };

        // Generate demo recipes as fallback with more pasta variety
        function generateDemoRecipes(calories, protein) {
            const searchTerm = protein.toLowerCase();
            const demoRecipes = [];
            // If user searches for pasta, provide popular pasta recipes
            if (searchTerm.includes('pasta') || searchTerm.includes('noodle')) {
                const pastaRecipes = [
                    {
                        title: `Creamy Pesto Pasta with ${protein}`,
                        image: 'https://images.unsplash.com/photo-1621996346565e3bc353d2e5?ixlib=rb-40.3&auto=format&fit=crop&w=800&q=80',
                        nutrition: {
                            nutrients: [
                                { name: 'Calories', amount: parseInt(calories) * 0.85 },
                                { name: 'Protein', amount: 32 },
                                { name: 'Fat', amount: 18 },
                                { name: 'Carbohydrates', amount: 45 },
                                { name: 'Sugar', amount: 6 },
                                { name: 'Fiber', amount: 7 }
                            ]
                        },
                        extendedIngredients: [
                            { original: `1 lb ${protein}, diced` },
                            { original: '12 oz fettuccine pasta' },
                            { original: '1/2p basil pesto' },
                            { original: '1/4p heavy cream' },
                            { original: '1/4 cup parmesan cheese' },
                            { original: '2 tbsp olive oil' },
                            { original: '3 cloves garlic, minced' },
                            { original: 'Salt and pepper to taste' }
                        ],
                        analyzedInstructions: [{
                            steps: [
                                { step: 'Bring a large pot of salted water to boil and cook pasta according to package directions.' },
                                { step: `Heat olive oil in a large skillet over medium heat. Add ${protein} and cook until golden brown.` },
                                { step: 'Add garlic and cook for 1 minute until fragrant.' },
                                { step: 'Stir in pesto and cream, simmer for 2 minutes.' },
                                { step: 'Add cooked pasta and parmesan cheese, toss to combine.' },
                                { step: 'Season with salt and pepper, serve immediately.' }
                            ]
                        }]
                    },
                    {
                        title: `Vodka Sauce Pasta with ${protein}`,
                        image: 'https://images.unsplash.com/photo-1563379926898-54575a45d8?ixlib=rb-40.3&auto=format&fit=crop&w=800&q=80',
                        nutrition: {
                            nutrients: [
                                { name: 'Calories', amount: parseInt(calories) * 0.9 },
                                { name: 'Protein', amount: 28 },
                                { name: 'Fat', amount: 22 },
                                { name: 'Carbohydrates', amount: 42 },
                                { name: 'Sugar', amount: 8 },
                                { name: 'Fiber', amount: 5 }
                            ]
                        },
                        extendedIngredients: [
                            { original: `1 lb ${protein}, sliced` },
                            { original: '12z penne pasta' },
                            { original: '1/2 cup heavy cream' },
                            { original: '1/4 cup tomato paste' },
                            { original: '1/4 cup parmesan cheese' },
                            { original: '2 tbsp olive oil' },
                            { original: '1 onion, diced' },
                            { original: '3 cloves garlic, minced' },
                            { original: 'Salt and pepper to taste' }
                        ],
                        analyzedInstructions: [{
                            steps: [
                                { step: 'Cook pasta in salted water until al dente, reserve1 cup pasta water.' },
                                { step: `Heat olive oil in a large skillet and cook ${protein} until browned. Remove and set aside.` },
                                { step: 'In the same skillet, sauté onion until translucent, add garlic.' },
                                { step: 'Add tomato paste and cook for 1te, then add vodka and simmer.' },
                                { step: 'Stir in cream and parmesan, add back the protein.' },
                                { step: 'Tosswith pasta, adding pasta water if needed for creaminess.' }
                            ]
                        }]
                    },
                    {
                        title: `Alfredo Pasta with ${protein}`,
                        image: 'https://images.unsplash.com/photo-155118353bf91a1d81141xlib=rb-40.3&auto=format&fit=crop&w=800&q=80',
                        nutrition: {
                            nutrients: [
                                { name: 'Calories', amount: parseInt(calories) * 0.95 },
                                { name: 'Protein', amount: 30 },
                                { name: 'Fat', amount: 25 },
                                { name: 'Carbohydrates', amount: 38 },
                                { name: 'Sugar', amount: 4 },
                                { name: 'Fiber', amount: 3 }
                            ]
                        },
                        extendedIngredients: [
                            { original: `1 lb ${protein}, cubed` },
                            { original: '12 oz fettuccine pasta' },
                            { original: '1/2 cup butter' },
                            { original: '1p heavy cream' },
                            { original: '1 cup parmesan cheese' },
                            { original: '3 cloves garlic, minced' },
                            { original: '1/4 cup parsley, chopped' },
                            { original: 'Salt and pepper to taste' }
                        ],
                        analyzedInstructions: [{
                            steps: [
                                { step: 'Cook pasta in salted water until al dente.' },
                                { step: `Season ${protein} with salt and pepper, cook in a large skillet until golden.` },
                                { step: 'Remove protein and set aside. In the same skillet, melt butter.' },
                                { step: 'Add garlic and cook for 30 seconds, then add cream.' },
                                { step: 'Simmer until slightly thickened, stir in parmesan cheese.' },
                                { step: 'Add back protein and pasta, toss to coat. Garnish with parsley.' }
                            ]
                        }]
                    }
                ];
                demoRecipes.push(...pastaRecipes);
            }
            
            // Add a general recipe based on the protein
            demoRecipes.push({
                title: `Delicious ${protein} Recipe`,
                image: 'https://images.unsplash.com/photo-1543353071-873f17a7a088?ixlib=rb-40.3&auto=format&fit=crop&w=800&q=80',
                nutrition: {
                    nutrients: [
                        { name: 'Calories', amount: parseInt(calories) * 0.8 },
                        { name: 'Protein', amount: 25 },
                        { name: 'Fat', amount: 12 },
                        { name: 'Carbohydrates', amount: 30 },
                        { name: 'Sugar', amount: 8 },
                        { name: 'Fiber', amount: 5 }
                    ]
                },
                extendedIngredients: [
                    { original: `1 lb ${protein}` },
                    { original: '2 tbsp olive oil' },
                    { original: '1 onion, diced' },
                    { original: '3 cloves garlic, minced' },
                    { original: 'Salt and pepper to taste' }
                ],
                analyzedInstructions: [{
                    steps: [
                        { step: `Season the ${protein} with salt and pepper.` },
                        { step: 'Heat olive oil in a large pan over medium heat.' },
                        { step: 'Add diced onion and cook until translucent.' },
                        { step: `Add ${protein} and cook until golden brown.` },
                        { step: 'Add garlic and cook for 1 minute.' },
                        { step: 'Serve hot and enjoy!' }
                    ]
                }]
            });
            
            return demoRecipes;
        }

        function displayRecipe() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (!recipes || recipes.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h3>No recipes available</h3>
                        <p>Please try generating recipes again.</p>
                    </div>
                `;
                return;
            }
            
            const recipe = recipes[currentIndex];
            console.log('Displaying recipe:', recipe);
            
            if (!recipe) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h3>Recipe not found</h3>
                        <p>Please try again.</p>
                    </div>
                `;
                return;
            }
            
            const { title, image, nutrition, extendedIngredients, analyzedInstructions } = recipe;
            const nutrients = nutrition.nutrients.reduce((acc, nut) => ({ ...acc, [nut.name]: nut.amount.toFixed(0) || 'N/A' }), {});

            const recipeDiv = document.createElement('div');
            recipeDiv.className = 'recipe-card animate__animated animate__fadeIn';
            recipeDiv.innerHTML = `
                <img src="${image}" alt="${title}" class="recipe-image" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1543353071-873f17a7a088?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
                <div class="recipe-content">
                    <h2 class="recipe-title">${title}</h2>
                    <div class="nutrition-grid">
                        <div class="nutrient-card"><span class="value">${nutrients.Calories || 'N/A'}</span><span>Calories</span></div>
                        <div class="nutrient-card"><span class="value">${nutrients.Protein || 'N/A'}g</span><span>Protein</span></div>
                        <div class="nutrient-card"><span class="value">${nutrients.Fat || 'N/A'}g</span><span>Fat</span></div>
                        <div class="nutrient-card"><span class="value">${nutrients.Carbohydrates || 'N/A'}g</span><span>Carbs</span></div>
                        <div class="nutrient-card"><span class="value">${nutrients.Sugar || 'N/A'}g</span><span>Sugar</span></div>
                        <div class="nutrient-card"><span class="value">${nutrients.Fiber || 'N/A'}g</span><span>Fiber</span></div>
                    </div>
                    <div class="ingredients-section">
                        <h3>Ingredients</h3>
                        <ul class="ingredient-list">${extendedIngredients.map(ing => `<li>${ing.original}</li>`).join('')}</ul>
                    </div>
                    <div class="instructions-section">
                        <h3>Instructions</h3>
                        <ol class="instruction-list">${analyzedInstructions.flatMap(section => section.steps.map(step => `<li>${step.step}</li>`)).join('')}</ol>
                    </div>
                    <div class="navigation">
                        <button onclick="prevRecipe()" ${currentIndex === 0 ? 'disabled' : ''} class="cta-button">Previous Recipe</button>
                        <button onclick="nextRecipe()" ${currentIndex === recipes.length - 1 ? 'disabled' : ''} class="cta-button">Next Recipe</button>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(recipeDiv);
            
            // Scroll to the recipe
            recipeDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        window.prevRecipe = function() {
            if (currentIndex > 0) {
                currentIndex--;
                displayRecipe();
            }
        };

        window.nextRecipe = function() {
            if (currentIndex < recipes.length - 1) {
                currentIndex++;
                displayRecipe();
            }
        };

        // Additional JS for interactivity
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile menu toggle
            const toggle = document.getElementById('mobile-menu-toggle');
            const menu = document.getElementById('mobile-nav');
            toggle.addEventListener('click', () => {
                menu.classList.toggle('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('user-dropdown-menu');
                const userEmail = document.querySelector('.user-email');
                
                if (dropdown && dropdown.classList.contains('active')) {
                    if (!userEmail || !userEmail.contains(event.target)) {
                        dropdown.classList.remove('active');
                    }
                }
            });

            // FAQ accordion
            const faqQuestions = document.querySelectorAll('.faq-question');
            faqQuestions.forEach(question => {
                question.addEventListener('click', () => {
                    const answer = question.nextElementSibling;
                    answer.classList.toggle('active');
                    question.classList.toggle('active');
                });
            });

            // Smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            // Subscription buttons - SIMPLIFIED AND BULLETPROOF
            const monthlyButton = document.getElementById('monthly-subscribe');
            if (monthlyButton) {
                monthlyButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('🔄 Monthly subscribe button clicked');
                    
                    try {
                        let user = auth.currentUser;
                        if (!user) {
                            console.log('👤 No user logged in, signing in...');
                            await window.signInWithGoogle();
                            user = auth.currentUser;
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                        
                        if (user) {
                            console.log('✅ User authenticated:', user.email);
                            
                            // Check subscription status
                            try {
                                const subscribed = await window.isSubscribed(user);
                                if (subscribed) {
                                    console.log('✅ User already subscribed, showing recipe generator');
                                    window.showRecipeGenerator();
                                    return;
                                }
                            } catch (error) {
                                console.error('❌ Error checking subscription:', error);
                            }
                            
                            // User not subscribed - open Whop checkout
                            console.log('💳 Opening Whop checkout for monthly plan');
                            const whopUrl = 'https://whop.com/checkout/plan_QAyjF6Q2hnSOe?d2c=true&email=' + encodeURIComponent(user.email);
                            
                            console.log('🔗 Whop URL:', whopUrl);
                            const popup = window.open(whopUrl, 'whop-checkout', 'width=500,height=700,scrollbars=yes,resizable=yes');
                            
                            if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                                console.log('❌ Popup blocked, redirecting');
                                alert('Please allow popups for this site to complete your subscription.');
                                window.location.href = stripeUrl;
                            } else {
                                console.log('✅ Stripe popup opened successfully');
                            }
                        } else {
                            console.log('❌ Failed to authenticate user');
                            alert('Please sign in to continue with your subscription.');
                        }
                    } catch (error) {
                        console.error('❌ Error in monthly subscribe:', error);
                        alert('An error occurred. Please try again.');
                    }
                });
            }

            const annualButton = document.getElementById('annual-subscribe');
            if (annualButton) {
                annualButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('🔄 Annual subscribe button clicked');
                    
                    try {
                        let user = auth.currentUser;
                        if (!user) {
                            console.log('👤 No user logged in, signing in...');
                            await window.signInWithGoogle();
                            user = auth.currentUser;
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                        
                        if (user) {
                            console.log('✅ User authenticated:', user.email);
                            
                            // Check subscription status
                            try {
                                const subscribed = await window.isSubscribed(user);
                                if (subscribed) {
                                    console.log('✅ User already subscribed, showing recipe generator');
                                    window.showRecipeGenerator();
                                    return;
                                }
                            } catch (error) {
                                console.error('❌ Error checking subscription:', error);
                            }
                            
                            // User not subscribed - open Whop checkout
                            console.log('💳 Opening Whop checkout for annual plan');
                            const whopUrl = 'https://whop.com/checkout/plan_nbdGYrSmUo2GH?d2c=true&email=' + encodeURIComponent(user.email);
                            
                            console.log('🔗 Whop URL:', whopUrl);
                            const popup = window.open(whopUrl, 'whop-checkout', 'width=500,height=700,scrollbars=yes,resizable=yes');
                            
                            if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                                console.log('❌ Popup blocked, redirecting');
                                alert('Please allow popups for this site to complete your subscription.');
                                window.location.href = stripeUrl;
                            } else {
                                console.log('✅ Stripe popup opened successfully');
                            }
                        } else {
                            console.log('❌ Failed to authenticate user');
                            alert('Please sign in to continue with your subscription.');
                        }
                    } catch (error) {
                        console.error('❌ Error in annual subscribe:', error);
                        alert('An error occurred. Please try again.');
                    }
                });
            }

            // Hero CTA button - "Start Your Culinary Journey"
            const heroCtaButton = document.querySelector('.hero-cta');
            if (heroCtaButton) {
                heroCtaButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('🔄 Hero CTA button clicked');
                    
                    try {
                        let user = auth.currentUser;
                        if (!user) {
                            console.log('👤 No user logged in, signing in...');
                            await window.signInWithGoogle();
                            user = auth.currentUser;
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                        
                        if (user) {
                            console.log('✅ User authenticated:', user.email);
                            
                            // Check subscription status
                            try {
                                const subscribed = await window.isSubscribed(user);
                                if (subscribed) {
                                    console.log('✅ User already subscribed, showing recipe generator');
                                    window.showRecipeGenerator();
                                    return;
                                }
                            } catch (error) {
                                console.error('❌ Error checking subscription:', error);
                            }
                            
                            // User not subscribed - show subscription options modal
                            console.log('💳 Showing subscription options modal');
                            const modalText = document.getElementById('modal-text');
                            modalText.innerHTML = `
                                <div style="text-align: center; padding: 2rem;">
                                    <h2 style="color: var(--primary); margin-bottom: 1rem;">🚀 Start Your Culinary Journey</h2>
                                    <p style="font-size: 1.1rem; margin-bottom: 2rem;">Choose your subscription plan to unlock unlimited AI-powered recipes!</p>
                                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                        <button class="cta-button" id="modal-monthly-subscribe" style="background: var(--accent);">Monthly Plan - $9.99</button>
                                        <button class="cta-button" id="modal-annual-subscribe" style="background: var(--primary);">Annual Plan - $99.99</button>
                                    </div>
                                    <button class="cta-button" onclick="closeModal()" style="background: #6b7280; margin-top: 1rem;">Cancel</button>
                                </div>
                            `;
                            document.getElementById('modal').style.display = 'flex';
                            
                            // Add event listeners for modal buttons
                            setTimeout(() => {
                                const modalMonthly = document.getElementById('modal-monthly-subscribe');
                                const modalAnnual = document.getElementById('modal-annual-subscribe');
                                if (modalMonthly) {
                                    modalMonthly.onclick = () => {
                                        console.log('🔄 Modal monthly button clicked');
                                        const successUrl = window.location.origin + '/?payment=success';
                                        const cancelUrl = window.location.origin + '/?payment=cancelled';
                                        const stripeUrl = 'https://buy.stripe.com/aFa3cw9GAczd2Sb6FTdQQ00?prefilled_email=' + encodeURIComponent(user.email) + '&client_reference_id=' + user.uid + '&success_url=' + encodeURIComponent(successUrl) + '&cancel_url=' + encodeURIComponent(cancelUrl);
                                        console.log('🔗 Opening Stripe URL:', stripeUrl);
                                        const popup = window.open(stripeUrl, 'stripe-checkout', 'width=500,height=700,scrollbars=yes,resizable=yes');
                                        if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                                            console.log('❌ Popup blocked, redirecting');
                                            alert('Please allow popups for this site to complete your subscription.');
                                            window.location.href = stripeUrl;
                                        } else {
                                            console.log('✅ Stripe popup opened successfully');
                                        }
                                    };
                                }
                                if (modalAnnual) {
                                    modalAnnual.onclick = () => {
                                        console.log('🔄 Modal annual button clicked');
                                        const successUrl = window.location.origin + '/?payment=success';
                                        const cancelUrl = window.location.origin + '/?payment=cancelled';
                                        const stripeUrl = 'https://buy.stripe.com/fZu8wQg4Y9n1dwP7JXdQQ01?prefilled_email=' + encodeURIComponent(user.email) + '&client_reference_id=' + user.uid + '&success_url=' + encodeURIComponent(successUrl) + '&cancel_url=' + encodeURIComponent(cancelUrl);
                                        console.log('🔗 Opening Stripe URL:', stripeUrl);
                                        const popup = window.open(stripeUrl, 'stripe-checkout', 'width=500,height=700,scrollbars=yes,resizable=yes');
                                        if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                                            console.log('❌ Popup blocked, redirecting');
                                            alert('Please allow popups for this site to complete your subscription.');
                                            window.location.href = stripeUrl;
                                        } else {
                                            console.log('✅ Stripe popup opened successfully');
                                        }
                                    };
                                }
                            }, 100);
                        } else {
                            console.log('❌ Failed to authenticate user');
                            alert('Please sign in to continue with your subscription.');
                        }
                    } catch (error) {
                        console.error('❌ Error in hero CTA:', error);
                        alert('An error occurred. Please try again.');
                    }
                });
            }
        });

        // Authentication Functions
        window.signInWithGoogle = async function() {
            try {
                console.log('🔄 Starting Google sign-in...');
                console.log('📍 Current domain:', window.location.hostname);
                console.log('📍 Current URL:', window.location.href);
                console.log('📍 Firebase auth domain:', firebaseConfig.authDomain);
                
                const provider = new GoogleAuthProvider();
                
                // Try popup first, fallback to redirect
                try {
                    console.log('🔄 Attempting popup sign-in...');
                    const result = await signInWithPopup(auth, provider);
                    console.log('✅ Sign-in successful via popup:', result.user.email);
                    return result.user;
                } catch (popupError) {
                    console.log('❌ Popup failed:', popupError.code, popupError.message);
                    console.log('🔄 Trying redirect sign-in...');
                    await signInWithRedirect(auth, provider);
                }
            } catch (error) {
                console.error('❌ Google sign-in error:', error);
                console.error('❌ Error code:', error.code);
                console.error('❌ Error message:', error.message);
                
                // More specific error messages
                if (error.code === 'auth/unauthorized-domain') {
                    alert('Domain not authorized. Please contact support.');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    alert('Sign-in popup was closed. Please try again.');
                } else if (error.code === 'auth/popup-blocked') {
                    alert('Popup was blocked. Please allow popups for this site.');
                } else {
                    alert('Sign-in failed: ' + error.message);
                }
                throw error;
            }
        };

        window.signOutUser = async function() {
            try {
                console.log('Signing out user...');
                await signOut(auth);
                console.log('User signed out successfully');
            } catch (error) {
                console.error('Sign-out error:', error);
                alert('Sign-out failed. Please try again.');
            }
        };

        // Stripe redirect functions
        window.redirectToStripe = async function(plan) {
            let user = auth.currentUser;
            if (!user) {
                // User not logged in - sign them in first
                await signInWithGoogle();
                user = auth.currentUser;
                // Wait a moment for auth to complete
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            if (user) {
                const successUrl = window.location.origin + '/?payment=success';
                const cancelUrl = window.location.origin + '/?payment=cancelled';
                
                let stripeUrl;
                if (plan === 'monthly') {
                    stripeUrl = 'https://buy.stripe.com/aFa3cw9GAczd2Sb6FTdQQ00?prefilled_email=' + encodeURIComponent(user.email) + '&client_reference_id=' + user.uid + '&success_url=' + encodeURIComponent(successUrl) + '&cancel_url=' + encodeURIComponent(cancelUrl);
                } else {
                    stripeUrl = 'https://buy.stripe.com/fZu8wQg4Y9n1dwP7JXdQQ01?prefilled_email=' + encodeURIComponent(user.email) + '&client_reference_id=' + user.uid + '&success_url=' + encodeURIComponent(successUrl) + '&cancel_url=' + encodeURIComponent(cancelUrl);
                }
                
                console.log('Opening Stripe checkout:', stripeUrl);
                const popup = window.open(stripeUrl, 'stripe-checkout', 'width=500,height=700,scrollbars=yes,resizable=yes');
                
                // Check if popup was blocked
                if (!popup || popup.closed || typeof popup.closed == 'undefined') {
                    alert('Please allow popups for this site to complete your subscription.');
                    // Fallback to redirect
                    window.location.href = stripeUrl;
                }
            }
        };
    </script>
    <style>
        .account-status { font-size: 0.8em; margin-left: 0.5em; padding: 0.2em 0.7em; border-radius: 8px; font-weight: 600; }
        .account-status.free { background: #f3f4f6; color: #6366f1; border: 1px solid #d1d5db; }
        .account-status.premium { background: var(--accent); color: #fff; border: 1px solid var(--accent); }
        .locked-generator .cta-button { margin-top: 1.5rem; }
    </style>
</body>
</html>